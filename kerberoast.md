# Kerberoast

## Description

Kerberoasting is a technique which is used to abuse the Kerberos protocol. Where Active Directory accounts which have Service Principal names (SPN's), a user is allowed to request a\_ _ticket-granting service_ \_(TGS) ticket for any SPN, and parts of the TGS may be encrypted with the with RC4 using the password hash of the service account assigned the requested SPN as the key

If we can crack these hashes offline we may then be able to make requests or authenticate as the related service or user account.

{% hint style="info" %}
Valid domain credentials are a hard requirement to pull SPN information
{% endhint %}

### Enumerating for SPN's

{% tabs %}
{% tab title="Powershell" %}
```bash
#Build LDAP Filter to look for users with SPN values registered for current domain
$ldapFilter = "(&(objectClass=user)(objectCategory=user)(servicePrincipalName=*))"
$domain = New-Object System.DirectoryServices.DirectoryEntry
$search = New-Object System.DirectoryServices.DirectorySearcher
$search.SearchRoot = $domain
$search.PageSize = 1000
$search.Filter = $ldapFilter
$search.SearchScope = "Subtree"
#Execute Search
$results = $search.FindAll()
#Display SPN values from the returned objects
$Results = foreach ($result in $results)
{
	$result_entry = $result.GetDirectoryEntry()
 
	$result_entry | Select-Object @{
		Name = "Username";  Expression = { $_.sAMAccountName }
	}, @{
		Name = "SPN"; Expression = { $_.servicePrincipalName | Select-Object -First 1 }
	}
}
 
$Results
```
{% endtab %}

{% tab title="Powershell" %}
Native PowerShell One Liner

```bash
get-adobject | Where-Object {$_.serviceprincipalname -ne $null -and $_.distinguishedname -like "*CN=Users*" -and $_.cn -ne "krbtgt"}
```
{% endtab %}

{% tab title="Powerview" %}
```bash
Get-NetUser | Where-Object {$_.servicePrincipalName} | fl
```
{% endtab %}

{% tab title="CMD" %}
```
setspn.exe -T security -Q */*
```
{% endtab %}
{% endtabs %}

## References:

* [https://www.youtube.com/watch?v=MeyTP7WoI2k](https://www.youtube.com/watch?v=MeyTP7WoI2k)
* [https://attack.stealthbits.com/cracking-kerberos-tgs-tickets-using-kerberoasting](https://attack.stealthbits.com/cracking-kerberos-tgs-tickets-using-kerberoasting)
