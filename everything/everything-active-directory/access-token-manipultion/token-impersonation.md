# Token Impersonation

## What is it

A token is like a cookie in where if you have one you do not have to provide your credentials every time you access a resource on the network. When a user logs on to a machine they can leave tokens behind. Tokens from logon events are known as delegate tokens.

## How To Perform The Attack

In this scenario we will be using Metasploit. This scenario assumes we already have gained shell access on the target system as the user 'Bart.Simpson'.

In Metasploit we can load the incognito module with the command `load incognito`. This will load the modules required to impersonate another users token. Once loaded we can use the `help` command to show if the module has loaded and what options are available to us.

![](<../../../../.gitbook/assets/image (1537).png>)

We can then list the available tokens for users with the `list_tokens -u` command.

![](<../../../../.gitbook/assets/image (1538).png>)

In the example below we will attempt to load the 'NT AUTHORITY\SYSTEM' token. with the command:

```
impersonate_token <token>
```

![](<../../../../.gitbook/assets/image (1539).png>)

Tokens will persist until a machine has been rebooted. Below I have rebooted the target machine and logged in as the user 'Lisa.Simpson'. I then exploited the machine and viewed available tokens. As we can see we have less available to us now that the machine has been rebooted.

![](<../../../../.gitbook/assets/image (1540).png>)

### **Rev2self**

The `meterpreter` command Rev2self can be used to revert to the original user token.

![](<../../../../.gitbook/assets/image (2042) (1) (1).png>)

## Token Types

#### Delegation

Are generally created when a user logs on interactively to the target system. Delegation tokens can be used elsewhere on the network.

#### Impersonation

Impersonation tokens run in an alternative security context to the process that started it. These tokens are generally not used elsewhere on the network.

****

{% hint style="info" %}
Due to the fact that tokens persist until reboot. Servers and File Servers are a potential treasure troves for tokens.
{% endhint %}

## Mitigations

| Mitigation                                                                  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| --------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [Privileged Account Management](https://attack.mitre.org/mitigations/M1026) | <p>Limit permissions so that users and user groups cannot create tokens. This setting should be defined for the local system account only. GPO: Computer Configuration > [Policies] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Create a token object. <a href="https://docs.microsoft.com/windows/device-security/security-policy-settings/create-a-token-object">[2]</a> Also define who can create a process level token to only the local and network service through GPO: Computer Configuration > [Policies] > Windows Settings > Security Settings > Local Policies > User Rights Assignment: Replace a process level token.<a href="https://docs.microsoft.com/windows/device-security/security-policy-settings/replace-a-process-level-token">[3]</a></p><p>Administrators should log in as a standard user but run their tools with administrator privileges using the built-in access token manipulation command <code>runas</code>.<a href="https://technet.microsoft.com/en-us/library/bb490994.aspx">[4]</a></p> |
| [User Account Management](https://attack.mitre.org/mitigations/M1018)       | An adversary must already have administrator level access on the local system to make full use of this technique; be sure to restrict users and accounts to the least privileges they require.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

Source: [https://attack.mitre.org/techniques/T1134/003/](https://attack.mitre.org/techniques/T1134/003/)
